# マニュアル

このドキュメントでは、Imaginrの機能と設計思想を詳しく説明します。

初めての方は、まず[チュートリアル](tutorial.md)をご覧ください。

---

## コンセプト

### なぜYAMLでプロンプトを管理するのか

画像生成AIのプロンプトは、細部まで指定しようとするとどんどん長く複雑になります。

自然言語で長いプロンプトを書くと：
- どこに何が書いてあるかわかりにくい
- 一部だけ変更したいとき、編集箇所を探すのが大変
- 似たプロンプトを作るとき、コピペして微調整...ミスも起きやすい

YAMLで構造化すると：
- 階層構造で整理され、見通しが良くなる
- 継承・合成で共通部分を再利用できる
- 変数で動的に値を変えられる

### プロンプトの構造: YAPS

Imaginrでは、**YAPS (Yet Another Prompt Schema)** という構造化スキーマを採用しています。

- `subject`, `pose`, `outfit`, `environment` などのキーで階層的に整理
- 詳細は [YAPS仕様書](YAPS.md) を参照

YAPSはあくまでガイドラインです。辞書のオートコンプリートで提案されますが、自分のワークフローに合わせて自由にカスタマイズできます。

### 4層構造: 変化頻度による整理

プロンプトを「どれくらい変わるか」で層に分けると、管理が楽になります。

```
変わりにくい（上位で固定）
    │
    ▼
┌─────────────────────────────────────────┐
│ 01_base: システム（品質、ブロック順序）  │  ← 絶対変わらない
├─────────────────────────────────────────┤
│ 02_look: 企画レベル                      │  ← 撮影を通して固定
│   被写体、ロケ地、機材、aesthetic        │
├─────────────────────────────────────────┤
│ 03_layers: パーツライブラリ              │  ← 組み合わせて使う
│   照明、ポーズ、表情のパターン           │
├─────────────────────────────────────────┤
│ 04_shot: カットレベル                    │  ← ショット毎に変わる
│   構図、ポーズ、表情、時間帯、小道具     │
├─────────────────────────────────────────┤
│ ${変数}: ランタイム                      │  ← 毎回変わる・まだ決めてない
└─────────────────────────────────────────┘
    │
    ▼
変わりやすい（下位 or 変数で残す）
```

| 層 | 何を置く | 例 |
|---|---|---|
| **01_base** | 絶対不変、全ブロックの順序定義 | quality タグ、ブロック構造 |
| **02_look** | 企画で固定するもの | 被写体、ロケ、カメラ、aesthetic |
| **03_layers** | 再利用パターン（横から合成） | lighting, pose, expression のパターン |
| **04_shot** | カット毎に変わるもの | composition, time, 背景詳細 |
| **${変数}** | 決めきれない・都度変えたい | hair_color, outfit_top 等 |

これはあくまで一つの整理方法です。自分のワークフローに合わせてカスタマイズしてください。

---

## 機能リファレンス

### テンプレート継承

#### `_base`: 縦の継承（IS-A）

親ファイルの内容をすべて引き継ぎ、差分だけを記述します。

```yaml
# 04_shot/shot_01.yaml
_base: 02_look/summer_casual.yaml

# このファイル固有の設定
pose:
  base: standing
  action: peace sign
```

親ファイルを修正すると、すべての子ファイルに反映されます。

#### `_layers`: 横の合成（HAS-A）

複数のファイルを順番にマージします。

```yaml
_base: 02_look/summer_casual.yaml

_layers:
  - 03_layers/lighting/golden_hour.yaml
  - 03_layers/pose/standing.yaml
  - 03_layers/expression/smile.yaml

# このファイル固有の設定
environment:
  time: evening
```

**適用順序**: `_base` → `_layers`（上から順に） → 自分自身

後から適用されるものが、前のものを上書きします。

#### `_base` vs `_layers` の使い分け

| | `_base` | `_layers` |
|---|---|---|
| **関係性** | 「〇〇である」（IS-A） | 「〇〇を持つ」（HAS-A） |
| **用途** | キャラ設定など本質的な継承 | 照明・ポーズなどパーツの組み合わせ |
| **数** | 1つだけ | 複数OK |

### 変数システム

#### 基本構文

```yaml
hair:
  color: ${hair_color}           # 変数
  style: ${hair_style|straight}  # デフォルト値付き
```

- `${変数名}`: 変数を定義
- `${変数名|デフォルト値}`: 値が入力されなかった場合のデフォルト

#### 変数入力フォーム

変数を含むファイルを選択すると、画面左下に入力フォームが表示されます。
値を入力すると、リアルタイムでMerged YAMLに反映されます。

#### プリセット

よく使う変数の組み合わせは、プリセットとして保存できます。

1. 変数に値を入力
2. 「Save Preset」をクリック
3. 名前をつけて保存

次回からはドロップダウンでプリセットを選ぶだけで、同じ設定を呼び出せます。

### 辞書とオートコンプリート

#### 辞書の役割

辞書には、よく使うキー名と値があらかじめ登録されています。

- エディタで入力中に**オートコンプリート**が表示されます
- 親キーのコンテキストを認識して、適切な候補を提示します
- 手動トリガー: **Cmd+J** (Mac) / **Ctrl+Space** (Windows)

#### 辞書ファイルの場所

辞書ファイルは `dictionary/` フォルダに配置されています。
設定ダイアログから「Open Data Folder」でデータフォルダを開き、直接編集できます。

### スニペット

スニペットは、よく使うYAMLの断片を保存しておく機能です。

#### `_layers`との違い

| | `_layers` | スニペット |
|---|---|---|
| **関係性** | 依存関係が残る | コピペして終わり |
| **更新時** | 元ファイル変更 → 全ショットに反映 | 挿入後は独立 |
| **用途** | 統一したい・一括変更したい | 出発点だけ欲しい |

**判断基準: 「これ、後で一括で変えたくなる？」**
- YES → `_layers` に外出し
- NO → スニペットで十分（または直書き）

#### 操作方法

右ペインのスニペットパネルで管理します。

- **シングルクリック**: 編集ダイアログを開く
- **ダブルクリック**: エディタのカーソル位置に挿入
- **右クリック**: コンテキストメニュー（削除など）

---

## ComfyUI連携

### 接続設定

1. ヘッダーの歯車アイコンから設定ダイアログを開く
2. 「ComfyUI設定」を選択
3. APIエンドポイントを入力（デフォルト: `http:/localhost:8188`）
4. 「テスト」で接続確認

### ワークフロー設定

ComfyUIのワークフローJSONをアップロードして、プロンプトの注入先を設定します。

1. 「Workflow」タブを開く
2. 「Add Workflow」でワークフローJSONをアップロード
3. 以下を設定:
   - **名前**: 表示名
   - **Prompt Node ID**: プロンプトを注入するノード（例：CLIPTextEncode）のID
   - **Sampler Node ID**: シードをランダム化するノード（例：KSampler）のID
   - **Overrides**: 画像サイズやステップ数などを上書きしたい場合

#### ノードIDの確認方法

ComfyUIでワークフローを開き、ノードを右クリック → 「Properties」でIDを確認できます。
または、ワークフローJSONを直接開いて確認することもできます。

### 画像生成

1. YAMLテンプレートを選択・編集
2. ワークフローを選択（ヘッダーのドロップダウン）
3. 「Generate」ボタンをクリック

生成された画像は自動的に保存され、ギャラリーに表示されます。

### ギャラリー

プレビューパネルの「Gallery」タブで、生成した画像を一覧表示できます。

- **サムネイルクリック**: 拡大表示
- **←→キー**: 前後の画像に移動
- **Escキー**: 拡大表示を閉じる
- **ダウンロードボタン**: 画像をファイルとして保存

---

## Ollama連携（LLMエンハンサー）

Ollamaを使って、YAMLプロンプトをテキストエンコーダーに最適化された形式に変換できます。

### Ollamaのインストール

1. [Ollama公式サイト](https://ollama.ai/)からインストーラーをダウンロード
2. インストール後、ターミナルで使いたいモデルをダウンロード:

```bash
# 例: Llama 3.2
ollama pull llama3.2

# 例: Qwen 2.5
ollama pull qwen2.5
```

### 接続設定

1. ヘッダーの歯車アイコンから設定ダイアログを開く
2. 「Ollama」タブを選択
3. 以下を設定:
   - **URL**: Ollamaのエンドポイント（デフォルト: `http://localhost:11434`）
   - **Model**: 使用するモデルを選択
   - **Temperature**: 生成の多様性（0.0〜1.0、デフォルト: 0.7）
4. 「Test Connection」で接続確認

### エンハンサープリセット

プリセットは、YAMLをどのような形式に変換するかを定義します。

| プリセット | 用途 | 出力形式 |
|------------|------|----------|
| **CLIP (SDXL)** | Stable Diffusion XL | カンマ区切りのタグ形式 |
| **T5 (Flux)** | Flux | 自然言語の文章形式 |
| **Qwen** | Qwen系モデル（Qwen-Image等） | 詳細な自然言語形式 |

プリセットはドロップダウンから選択できます。また、「Add Preset」で独自のプリセットを追加することもできます。

### 使い方

#### 手動エンハンス

1. YAMLテンプレートを選択・編集
2. 「Enhance」ボタンをクリック
3. 変換されたプロンプトが「Prompt」タブに表示される

#### 生成時に自動エンハンス

1. 生成パネルの「Enhance before generate」をオンにする
2. 「Generate」ボタンをクリック
3. 自動的にエンハンス → 画像生成が実行される

### AI Assist（Text-to-Prompt）

自然言語の説明からYAPSフォーマットのYAMLを生成する機能です。

1. エディタ上部の「AI Assist」ボタンをクリック
2. 作りたい画像の説明を入力（例：「夕暮れの浜辺で佇む少女」）
3. 「Generate」をクリック
4. 生成されたYAMLがエディタに挿入される

この機能はざっくりとした説明から詳細なYAMLを生成するので、そこから微調整していくワークフローに適しています。

---

## FAQ / Tips

（準備中）
