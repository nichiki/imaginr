# マニュアル

このドキュメントでは、Imaginrの機能と設計思想を詳しく説明します。

初めての方は、まず[チュートリアル](tutorial_ja.md)をご覧ください。

---

## コンセプト

### なぜYAMLでプロンプトを管理するのか

画像生成AIのプロンプトは、細部まで指定しようとするとどんどん長く複雑になります。

自然言語で長いプロンプトを書くと：
- どこに何が書いてあるかわかりにくい
- 一部だけ変更したいとき、編集箇所を探すのが大変
- 似たプロンプトを作るとき、コピペして微調整...ミスも起きやすい

YAMLで構造化すると：
- 階層構造で整理され、見通しが良くなる
- 継承・合成で共通部分を再利用できる
- 変数で動的に値を変えられる

### プロンプトの構造: YAPS

Imaginrでは、**YAPS (Yet Another Prompt Schema)** という構造化スキーマを採用しています。

- `subject`, `pose`, `outfit`, `environment` などのキーで階層的に整理
- 詳細は [YAPS仕様書](YAPS_ja.md) を参照

YAPSはあくまでガイドラインです。辞書のオートコンプリートで提案されますが、自分のワークフローに合わせて自由にカスタマイズできます。

### 4層構造: 変化頻度による整理

プロンプトを「どれくらい変わるか」で層に分けると、管理が楽になります。

```
変わりにくい（上位で固定）
    │
    ▼
┌─────────────────────────────────────────┐
│ 01_base: システム（品質、ブロック順序）  │  ← 絶対変わらない
├─────────────────────────────────────────┤
│ 02_look: 企画レベル                      │  ← 撮影を通して固定
│   被写体、ロケ地、機材、aesthetic        │
├─────────────────────────────────────────┤
│ 03_layers: パーツライブラリ              │  ← 組み合わせて使う
│   照明、ポーズ、表情のパターン           │
├─────────────────────────────────────────┤
│ 04_shot: カットレベル                    │  ← ショット毎に変わる
│   構図、ポーズ、表情、時間帯、小道具     │
├─────────────────────────────────────────┤
│ ${変数}: ランタイム                      │  ← 毎回変わる・まだ決めてない
└─────────────────────────────────────────┘
    │
    ▼
変わりやすい（下位 or 変数で残す）
```

| 層 | 何を置く | 例 |
|---|---|---|
| **01_base** | 絶対不変、全ブロックの順序定義 | quality タグ、ブロック構造 |
| **02_look** | 企画で固定するもの | 被写体、ロケ、カメラ、aesthetic |
| **03_layers** | 再利用パターン（横から合成） | lighting, pose, expression のパターン |
| **04_shot** | カット毎に変わるもの | composition, time, 背景詳細 |
| **${変数}** | 決めきれない・都度変えたい | hair_color, outfit_top 等 |

これはあくまで一つの整理方法です。自分のワークフローに合わせてカスタマイズしてください。

---

## 機能リファレンス

### エディタ

#### 複数タブ

複数のファイルをタブで開くことができます。

- **タブ追加**: タブバー右端の「+」ボタン、またはファイルツリーからファイルを選択
- **タブ切り替え**: タブをクリック
- **タブを閉じる**: タブの「×」ボタン（未保存の変更がある場合は確認あり）

#### エディタ分割

エディタを左右に分割して、2つのファイルを同時に編集できます。

- タブを右クリック → 「右で開く」または「左で開く」
- 分割を解除するには、片方のタブをすべて閉じる

#### レイアウトモード

画面右上のアイコンで、レイアウトを切り替えられます。

| モード | 説明 |
|--------|------|
| **全表示** | 上段（エディタ）と下段（プレビュー・生成）両方を表示 |
| **上段のみ** | エディタに集中したいとき |
| **下段のみ** | ギャラリーや生成パネルに集中したいとき |

### テンプレート継承

#### `_base`: 縦の継承（IS-A）

親ファイルの内容をすべて引き継ぎ、差分だけを記述します。

```yaml
# 04_shot/shot_01.yaml
_base: 02_look/summer_casual.yaml

# このファイル固有の設定
pose:
  base: standing
  action: peace sign
```

親ファイルを修正すると、すべての子ファイルに反映されます。

#### `_layers`: 横の合成（HAS-A）

複数のファイルを順番にマージします。

```yaml
_base: 02_look/summer_casual.yaml

_layers:
  - 03_layers/lighting/golden_hour.yaml
  - 03_layers/pose/standing.yaml
  - 03_layers/expression/smile.yaml

# このファイル固有の設定
environment:
  time: evening
```

**適用順序**: `_base` → `_layers`（上から順に） → 自分自身

後から適用されるものが、前のものを上書きします。

#### `_replace`: マージではなく置換

デフォルトでは、オブジェクトは深くマージされます。親ファイルに定義があれば、その上に子の設定が重なります。

```yaml
# 親ファイル
outfit:
  top: blazer
  bottom: skirt
  legwear: tights
```

```yaml
# 子ファイル（通常のマージ）
outfit:
  top: sweater
# → 結果: top=sweater, bottom=skirt, legwear=tights（マージされる）
```

しかし、親の内容を引き継ぎたくない場合もあります。`_replace` を使うと、指定したキーは深いマージではなく**完全置換**になります。

```yaml
# 子ファイル（_replace使用）
_replace:
  - outfit

outfit:
  top: sweater
# → 結果: top=sweater のみ（bottom, legwear は消える）
```

**使いどころ**: 親の設定を「部分的に上書き」ではなく「まるごと差し替え」したいとき。

#### `_base` vs `_layers` の使い分け

| | `_base` | `_layers` |
|---|---|---|
| **関係性** | 「〇〇である」（IS-A） | 「〇〇を持つ」（HAS-A） |
| **用途** | キャラ設定など本質的な継承 | 照明・ポーズなどパーツの組み合わせ |
| **数** | 1つだけ | 複数OK |

### 変数システム

#### 基本構文

```yaml
hair:
  color: ${hair_color}           # 変数
  style: ${hair_style|straight}  # デフォルト値付き
```

- `${変数名}`: 変数を定義
- `${変数名|デフォルト値}`: 値が入力されなかった場合のデフォルト

#### 変数入力フォーム

変数を含むファイルを選択すると、画面左下に入力フォームが表示されます。
値を入力すると、リアルタイムでMerged YAMLに反映されます。

#### プリセット

よく使う変数の組み合わせは、プリセットとして保存できます。

1. 変数に値を入力
2. 「Save Preset」をクリック
3. 名前をつけて保存

次回からはドロップダウンでプリセットを選ぶだけで、同じ設定を呼び出せます。

### 辞書とオートコンプリート

#### 辞書の役割

辞書には、よく使うキー名と値があらかじめ登録されています。

- エディタで入力中に**オートコンプリート**が表示されます
- 親キーのコンテキストを認識して、適切な候補を提示します
- 手動トリガー: **Cmd+J** (Mac) / **Ctrl+Space** (Windows)

#### 辞書の管理

辞書はアプリ内から直接管理できます。

1. ヘッダーの歯車アイコンから設定ダイアログを開く
2. 「辞書マネージャー」を選択
3. 以下の操作が可能:
   - **検索・フィルタリング**: キーワードやコンテキストで絞り込み
   - **追加**: 新しいエントリを登録
   - **編集**: 既存エントリの修正
   - **削除**: 不要なエントリを削除
   - **インポート/エクスポート**: CSV形式でのバックアップ・復元

#### オートコンプリートの詳細

オートコンプリートでは、候補の右側に**ソースコンテキスト**が表示されます。

例えば `outfit.top.color` を編集中に補完候補が表示された場合:
- `*.color` - 汎用の色辞書から
- `outfit.color` - outfit固有の色表現から

この情報により、候補がどの辞書コンテキストから来ているか確認できます。

#### 辞書ファイルの直接編集

辞書ファイルは `dictionary/` フォルダにも配置されています。
設定ダイアログから「Open Data Folder」でデータフォルダを開き、直接編集することも可能です。

### スニペット

スニペットは、よく使うYAMLの断片を保存しておく機能です。

#### `_layers`との違い

| | `_layers` | スニペット |
|---|---|---|
| **関係性** | 依存関係が残る | コピペして終わり |
| **更新時** | 元ファイル変更 → 全ショットに反映 | 挿入後は独立 |
| **用途** | 統一したい・一括変更したい | 出発点だけ欲しい |

**判断基準: 「これ、後で一括で変えたくなる？」**
- YES → `_layers` に外出し
- NO → スニペットで十分（または直書き）

#### 操作方法

右ペインのスニペットパネルで管理します。

- **シングルクリック**: 編集ダイアログを開く
- **ダブルクリック**: エディタのカーソル位置に挿入
- **右クリック**: コンテキストメニュー（削除など）

---

## ComfyUI連携

### 接続設定

1. ヘッダーの歯車アイコンから設定ダイアログを開く
2. 「ComfyUI設定」を選択
3. APIエンドポイントを入力（デフォルト: `http://localhost:8188`）
4. 「テスト」で接続確認

### ワークフロー設定

ComfyUIのワークフローJSONをアップロードして、プロンプトの注入先を設定します。
事前準備として、使いたいワークフローをAPI形式でエクスポートしておきます。

1. 「ComfyUI設定」の下の「追加」を選択
2. エクスポートしたワークフローJSONをアップロード
3. 以下を設定:
   - **名前**: 表示名
   - **プロンプトノード ID**: プロンプトを注入するノード（例：CLIPTextEncode）のID
   - **サンプラーノード ID**: シードをランダム化するノード（例：KSampler）のID
   - **ネガティブプロンプトノード ID**: ネガティブプロンプトをYAMLで制御したい場合のみ
   - **プロパティ上書き**: 画像サイズやステップ数などを上書きしたい場合

#### ノードIDの確認方法

ワークフローJSONをテキストエディタなどで開いて確認できます。

### 画像生成

1. YAMLテンプレートを選択・編集
2. ワークフローを選択（生成パネルのドロップダウン）
3. 「生成」ボタンをクリック

生成された画像は自動的に保存され、ギャラリーに表示されます。

### ギャラリー

プレビューパネルの「Gallery」タブで、生成した画像を一覧表示できます。

- **サムネイルクリック**: 拡大表示
- **←→キー**: 前後の画像に移動
- **Escキー**: 拡大表示を閉じる
- **ダウンロードボタン**: 画像をファイルとして保存

---

## Ollama連携（LLMエンハンサー）

Ollamaを使って、YAMLプロンプトをテキストエンコーダーに最適化された形式に変換できます。

### Ollamaのインストール

1. [Ollama公式サイト](https://ollama.ai/)からインストーラーをダウンロード
2. インストール後、ターミナルで使いたいモデルをダウンロード:

```bash
# 例: Llama 3.2
ollama pull llama3.2

# 例: Qwen 2.5
ollama pull qwen2.5
```

### 接続設定

1. ヘッダーの歯車アイコンから設定ダイアログを開く
2. 「Ollama設定」を選択
3. 以下を設定:
   - **API URL**: Ollamaのエンドポイント（デフォルト: `http://localhost:11434`）
   - **モデル**: 使用するモデルを選択
   - **Temperature**: 生成の多様性（0.0〜1.0、デフォルト: 0.7）
4. 「テスト」で接続確認

### エンハンサープリセット

プリセットは、YAMLをどのような形式に変換するかを定義します。

| プリセット | 用途 | 出力形式 |
|------------|------|----------|
| **CLIP (SDXL)** | Stable Diffusion XL | カンマ区切りのタグ形式 |
| **T5 (Flux)** | Flux | 自然言語の文章形式 |
| **Qwen** | Qwen系モデル（Qwen-Image等） | 詳細な自然言語形式 |

プリセットはドロップダウンから選択できます。また、「Add Preset」で独自のプリセットを追加することもできます。

### 使い方

#### 手動エンハンス

1. YAMLテンプレートを選択・編集
2. 生成パネルの「エンハンス」ボタンをクリック
3. 変換されたプロンプトが「プロンプト」タブの「エンハンス済み」に表示される

#### 生成時に自動エンハンス

1. 生成パネルの「生成時にエンハンス」をオンにする
2. 「生成」ボタンをクリック
3. 自動的にエンハンス → 画像生成が実行される

### AI アシスト（Text-to-Prompt）

自然言語の説明からYAPSフォーマットのYAMLを生成する機能です。

1. ファイルの新規作成時に「AI アシスト」をオンにする
2. 作りたい画像の説明を入力（例：「夕暮れの浜辺で佇む少女」）
3. 「作成」をクリック
4. 生成されたYAMLがエディタに挿入される

この機能はざっくりとした説明から詳細なYAMLを生成するので、そこから微調整していくワークフローに適しています。

---

## FAQ / Tips

### よくある質問

#### Q: ブラウザで動作しますか？

A: いいえ、Imaginrはデスクトップアプリ専用です。Tauri経由でファイルシステムやデータベースにアクセスするため、ブラウザでは動作しません。

#### Q: データはどこに保存されますか？

A: 以下の場所に保存されます:
- **Windows**: `%APPDATA%/studio.imaginr/`
- **Mac**: `~/Library/Application Support/studio.imaginr/`

設定ダイアログの「Open Data Folder」からフォルダを開けます。

#### Q: ComfyUIなしでも使えますか？

A: はい、プロンプトの作成・管理機能は単独で使えます。画像生成だけがComfyUI連携が必要です。

#### Q: 辞書に自分で値を追加できますか？

A: はい、設定ダイアログの「辞書マネージャー」から追加・編集・削除ができます。CSV形式でのインポート/エクスポートも可能です。

#### Q: 自動保存はありますか？

A: いいえ、自動保存はありません。**Ctrl+S**（Mac: **Cmd+S**）で明示的に保存してください。未保存の変更がある場合、タブに「●」マークが表示されます。

### Tips

#### 効率的なワークフロー

1. **ベースを先に固める**: キャラクターの基本設定を `_base` ファイルにまとめておく
2. **レイヤーライブラリを作る**: 照明・ポーズ・表情のバリエーションを `_layers` で再利用
3. **変数は最後に**: まずは固定値で画作りし、後から変数化する

#### キーボードショートカット

**一般**

| 操作 | Windows | Mac |
|------|---------|-----|
| 保存 | Ctrl+S | Cmd+S |
| タブを閉じる | Ctrl+W | Cmd+W |
| 元に戻す | Ctrl+Z | Cmd+Z |
| やり直し | Ctrl+Y | Cmd+Shift+Z |

**エディタ**

| 操作 | Windows | Mac |
|------|---------|-----|
| オートコンプリート | Ctrl+J / Ctrl+Space | Cmd+J |
| 辞書に追加 | Ctrl+Shift+D | Cmd+Shift+D |

**生成**

| 操作 | Windows | Mac |
|------|---------|-----|
| 画像生成 | Ctrl+Enter | Cmd+Enter |
| プロンプトをエンハンス | Ctrl+E | Cmd+E |

**ギャラリー（拡大表示時）**

| 操作 | キー |
|------|------|
| 前の画像 | ← |
| 次の画像 | → |
| 閉じる | Esc |

**その他**

| 操作 | 方法 |
|------|------|
| 分割エディタで開く | Cmd/Ctrl + ファイルをクリック |
| ギャラリーで範囲選択 | Shift + クリック |
